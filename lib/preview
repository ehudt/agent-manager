#!/usr/bin/env bash
# preview - Fast standalone preview for fzf
# Usage: preview <session_name>

set -euo pipefail

session_name="${1:-}"

if [[ -z "$session_name" ]]; then
    echo "No session selected"
    exit 0
fi

# Check session exists
if ! tmux has-session -t "$session_name" 2>/dev/null; then
    echo "Session not found: $session_name"
    exit 0
fi

# Source utils for claude_first_user_message helper
source "$(dirname "${BASH_SOURCE[0]}")/utils.sh"

# Get session title from Claude JSONL
AM_REGISTRY="${AM_REGISTRY:-${HOME}/.agent-manager/sessions.json}"
if [[ -f "$AM_REGISTRY" ]]; then
    directory=$(jq -r --arg name "$session_name" '.sessions[$name].directory // empty' "$AM_REGISTRY" 2>/dev/null)

    if [[ -n "$directory" ]]; then
        title=$(claude_first_user_message "$directory" || true)
        if [[ -n "$title" ]]; then
            # Clean up for display: remove URLs, extract first sentence
            title=$(echo "$title" | sed 's/https\?:\/\/[^ ]*//g; s/  */ /g; s/[.?!].*//' | head -c 60)
            echo -e "\033[1;36mðŸ“ $title\033[0m"
            echo ""
        fi
    fi
fi

# Capture terminal output from the agent pane (top pane)
# -p: print to stdout
# -e: include escape sequences (colors)
# No -S flag = capture visible area only
output=$(tmux capture-pane -t "$session_name:.{top}" -p -e 2>/dev/null || \
         tmux capture-pane -t "$session_name" -p -e 2>/dev/null)

# Show last 33 lines of captured content
if [[ -n "$output" ]]; then
    echo "$output" | tail -n 33
else
    echo "(Unable to capture)"
fi
