#!/usr/bin/env bash
# Kill a session and switch to the last used one if we killed the current session

target="$1"
if [[ -z "$target" ]]; then
    exit 1
fi

# Resolve the real script path so installed symlinks still find the repo libs.
script_path="${BASH_SOURCE[0]}"
while [[ -L "$script_path" ]]; do
    script_dir="$(cd "$(dirname "$script_path")" && pwd -P)"
    script_path="$(readlink "$script_path")"
    [[ "$script_path" != /* ]] && script_path="$script_dir/$script_path"
done
script_dir="$(cd "$(dirname "$script_path")" && pwd -P)"
repo_dir="$(cd "$script_dir/.." && pwd -P)"

# Get current attached session
current=$(tmux display-message -p '#{session_name}' 2>/dev/null)

# Source agent_kill function
source "$repo_dir/lib/utils.sh"
source "$repo_dir/lib/tmux.sh"
source "$repo_dir/lib/registry.sh"
source "$repo_dir/lib/agents.sh"

# If killing the current session, switch to another one first
if [[ "$target" == "$current" ]]; then
    # Find the next best session (most recent that isn't the target)
    next=$(tmux list-sessions -F '#{session_activity} #{session_name}' 2>/dev/null \
        | grep ' am-' \
        | grep -v " ${target}$" \
        | sort -rn \
        | head -1 \
        | cut -d' ' -f2)

    if [[ -n "$next" ]]; then
        tmux switch-client -t "$next"
    fi
fi

# Now kill the target session
agent_kill "$target"
